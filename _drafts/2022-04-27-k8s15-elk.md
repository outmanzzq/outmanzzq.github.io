---
layout: post
title: K8S(15)监控实战-ELK 收集 K8S 内应用日志
categories: docker,k8s
description: ELK 是 Elasticsearch、Logstash、Kibana 三大开源框架首字母大写简称。市面上也被称为 Elastic Stack。其中 Elasticsearch 是一个基于 Lucene、分布式、通过 Restful 方式进行交互的近实时搜索平台框架。
keywords: docker,k8s,elk,log
---

## 1 收集 K8S 日志方案

K8S 系统里的业务应用是高度“动态化”的，随着容器编排的进行，业务容器在不断的被创建、被摧毁、被漂移、被扩缩容…

我们需要这样一套日志收集、分析的系统：

1. 收集 – 能够采集多种来源的日志数据（流式日志收集器）
2. 传输 – 能够稳定的把日志数据传输到中央系统（消息队列）
3. 存储 – 可以将日志以结构化数据的形式存储起来（搜索引擎）
4. 分析 – 支持方便的分析、检索方法，最好有 GUI 管理系统（ web ）
5. 警告 – 能够提供错误报告，监控机制（监控系统）

### 1.1 传统ELk模型缺点：

![img](/images/20220427-k8s15-elk-01.jpg)

1. Logstash 使用 Jruby 语言开发，吃资源，大量部署消耗极高
2. 业务程序与 Logstash 耦合过松，不利于业务迁移
3. 日志收集与 ES 耦合又过紧，（ Logstash ）易打爆（ ES ）、丢数据
4. 在容器云环境下，传统 ELk 模型难以完成工作

### 1.2 K8S 容器日志收集模型

![img](/images/20220427-k8s15-elk-02.jpg)

## 2 制作 TOMCAT 底包

### 2.1 准备 TOMCAT 底包

#### 2.1.1 下载 TOMCAT8

```sh
cd /opt/src/
wget https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.50/bin/apache-tomcat-8.5.50.tar.gz
mkdir /data/dockerfile/tomcat
tar xf apache-tomcat-8.5.50.tar.gz -C /data/dockerfile/tomcat
cd /data/dockerfile/tomcat
```

#### 2.1.2 简单配置 TOMCAT

**删除自带网页**

```sh
rm -rf apache-tomcat-8.5.50/webapps/*
```

**关闭 AJP 端口**

> AJP 端口为前端 Apache 时调用，故前端采用 Nginx 时不需要。

```sh
tomcat]# vim apache-tomcat-8.5.50/conf/server.xml
  <!-- <Connector port="8009" protocol="AJP/1.3" redirectPort="8443" /> -->
```

**修改日志类型**

> 删除 3manager，4host-manager 的 Handlers

```properties
tomcat]# vim apache-tomcat-8.5.50/conf/logging.properties
handlers = 
  [1catalina.org.apache.juli.AsyncFileHandler](http://1catalina.org.apache.juli.asyncfilehandler/), 
  [2localhost.org.apache.juli.AsyncFileHandler](http://2localhost.org.apache.juli.asyncfilehandler/), 
java.util.logging.ConsoleHandler
```

**日志级别改为 INFO**

```properties
1catalina.org.apache.juli.AsyncFileHandler.level = INFO
2localhost.org.apache.juli.AsyncFileHandler.level = INFO
java.util.logging.ConsoleHandler.level = INFO
```

**注释所有关于 3manager，4host-manager 日志的配置**

```properties
# 3manager.org.apache.juli.AsyncFileHandler.level = FINE
# 3manager.org.apache.juli.AsyncFileHandler.directory = ${catalina.base}/logs
# 3manager.org.apache.juli.AsyncFileHandler.prefix = manager.
# 3manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8
# 4host-manager.org.apache.juli.AsyncFileHandler.level = FINE
# 4host-manager.org.apache.juli.AsyncFileHandler.directory = ${catalina.base}/logs
# 4host-manager.org.apache.juli.AsyncFileHandler.prefix = host-manager.
# 4host-manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8
```

### 2.2 准备 Docker 镜像

#### 2.2.1 创建 Dockerfile

```Dockerfile
cat >Dockerfile <<'EOF'
From harbor.zq.com/public/jre:8u112
RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\
  echo 'Asia/Shanghai' >/etc/timezone
ENV CATALINA_HOME /opt/tomcat
ENV LANG zh_CN.UTF-8
ADD apache-tomcat-8.5.50/ /opt/tomcat
ADD config.yml /opt/prom/config.yml
ADD jmx_javaagent-0.3.1.jar /opt/prom/jmx_javaagent-0.3.1.jar
WORKDIR /opt/tomcat
ADD entrypoint.sh /entrypoint.sh
CMD ["/bin/bash","/entrypoint.sh"]
EOF
```

#### 2.2.2 准备 Dockerfile 所需文件

JVM 监控所需 JAR 包

```sh
wget  -O jmx_javaagent-0.3.1.jar https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.3.1/jmx_prometheus_javaagent-0.3.1.jar
```

jmx_agent 读取的配置文件

```sh
cat >config.yml <<'EOF'
---
rules:
 - pattern: '.*'
EOF
```

容器启动脚本

```sh
cat  >entrypoint.sh <<'EOF'
#!/bin/bash

# Pod ip:port 监控规则传给jvm监控客户端
M_OPTS="-Duser.timezone=Asia/Shanghai -javaagent:/opt/prom/jmx_javaagent-0.3.1.jar=$(hostname -i):${M_PORT:-"12346"}:/opt/prom/config.yml"

C_OPTS=${C_OPTS}    # 启动追加参数

MIN_HEAP=${MIN_HEAP:-"128m"} # JAVA 虚拟机初始化时的最小内存
MAX_HEAP=${MAX_HEAP:-"128m"} # JAVA 虚拟机初始化时的最大内存

# 年轻代，GC 回收
JAVA_OPTS=${JAVA_OPTS:-"-Xmn384m -Xss256k -Duser.timezone=GMT+08  -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSClassUnloadingEnabled -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=80 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+PrintClassHistogram  -Dfile.encoding=UTF8 -Dsun.jnu.encoding=UTF8"}

CATALINA_OPTS="${CATALINA_OPTS}"

JAVA_OPTS="${M_OPTS} ${C_OPTS} -Xms${MIN_HEAP} -Xmx${MAX_HEAP} ${JAVA_OPTS}"

sed -i -e "1a\JAVA_OPTS=\"$JAVA_OPTS\"" -e "1a\CATALINA_OPTS=\"$CATALINA_OPTS\"" /opt/tomcat/bin/catalina.sh

cd /opt/tomcat && /opt/tomcat/bin/catalina.sh run 2>&1 >> /opt/tomcat/logs/stdout.log # 日志文件

EOF
```

#### 2.2.3 构建 Docker

```sh
docker build . -t harbor.zq.com/base/tomcat:v8.5.50
docker push       harbor.zq.com/base/tomcat:v8.5.50
```

### 2.3 构建 Dubbo 消费者服务（Tomcat 版）

#### 2.3.1 通过 Jenkins 构建 Dubbo 消费者镜像（Tomcat 版）

1. 新建 Jenkins Pipeline 流水线：

   - item name：tomcat-demo
   - 选择 -> 流水线

   ![img](/images/20220427-k8s15-elk-03.png)

2. 勾选： Discard old builds

   -  Days to keep builds ：3
   -  Max # of builds to keep ：30

3. 勾选： This project is parameterized 

   > 注意：全部勾选   Trim the string

   - **1：Add Parameter -> String Parameter**
     -  Name:  app_name
     -  Default Value :
     -  Description :  project name e g: dubbo-demo-web
   - **2:  Add Parameter -> String Parameter**
     -  Name: image_name
     -  Default Value :
     -  Description :  project docker image name. e g: app/dubbo-demo-web
   - **3:  Add Parameter -> String Parameter**
     -  Name:  git_repo
     -  Default Value :  
     -  Description :  project git repository. e g: git@gitee.com:outmanzzq/dubbo-demo-web.git
   - **4:  Add Parameter -> String Parameter**
     -  Name:   git_ver
     -  Default Value :  tomcat
     -  Description :  git commit id of the project
   - **5:  Add Parameter -> String Parameter**
     -  Name:  add_tag
     -  Default Value :
     -  Description :  project docker image tag. date_timestamp 
       recommended e.g: 20220428_2052
   - **6:  Add Parameter -> String Parameter**
     -  Name:  target_dir
     -  Default Value :  ./dubbo-client/target
     -  Description :  the relative path of file such as jar or war package.
       e.g: ./dubbo-client/target
   - **7:  Add Parameter -> String Parameter**
     -  Name:  mvn_dir
     -  Default Value :  ./
     -  Description :  project maven directory. e.g: ./
   - **8:  Add Parameter -> String Parameter**
     -  Name:  mvn_cmd
     -  Default Value :  mvn clean package -Dmaven.test.skip=true
     -  Description :  maven command. 
       e.g: mvn clean package -e -q -Dmaven.test.skip=true
   - **9：Add Parameter -> Choice Parameter**
     -  Name:  base_image
     -  Choices  :  base/tomcat:v7.0.94
       base/tomcat:v8.5.50
       base/tomcat:v9.0.17
     -  Description :  project base image list in harbor.zq.com
   - **9：Add Parameter -> Choice Parameter**
     -  Name:  maven
     -  Choices  :  3.6.1
       3.2.5
       2.2.1
     -  Description :  different maven edition
   - **10：Add Parameter -> String Parameter****
     -  Name:  root_url
     -  Default Value :  ROOT
     -  Description :  webapp dir.

4.  **Pipeline** -> Pipeline script

```
pipeline {
  agent any 
    stages {
      stage('pull') { //get project code from repo 
        steps {
          sh "git clone ${params.git_repo} ${params.app_name}/${env.BUILD_NUMBER} && cd ${params.app_name}/${env.BUILD_NUMBER} && git checkout ${params.git_ver}"
        }
      }
      stage('build') { //exec mvn cmd
        steps {
          sh "cd ${params.app_name}/${env.BUILD_NUMBER}  && /var/jenkins_home/maven-${params.maven}/bin/${params.mvn_cmd}"
        }
      }
      stage('unzip') { //unzip target/*.war -c target/project_dir
        steps {
          sh "cd ${params.app_name}/${env.BUILD_NUMBER} && cd ${params.target_dir} && mkdir project_dir && unzip *.war -d ./project_dir"
        }
      }
      stage('image') { //build image and push to registry
        steps {
          writeFile file: "${params.app_name}/${env.BUILD_NUMBER}/Dockerfile", text: """FROM harbor.zq.com/${params.base_image}
ADD ${params.target_dir}/project_dir /opt/tomcat/webapps/${params.root_url}"""
          sh "cd  ${params.app_name}/${env.BUILD_NUMBER} && docker build -t harbor.zq.com/${params.image_name}:${params.git_ver}_${params.add_tag} . && docker push harbor.zq.com/${params.image_name}:${params.git_ver}_${params.add_tag}"
        }
      }
    }
}
```

![img](/images/20220427-k8s15-elk-04.png)



4.  Jenkins => 流水线：tomcat-demo =>新建 build，参数如图：

![img](/images/20220427-k8s15-elk-05.png)

> build 完成，Harbor 仓库 -> app/dubbo-demo-web 将生成 Dubbo 消费者 Tomcat 镜像：
>
> harbor.zq.com:180/app/dubbo-demo-web:tomcat_20220428_2200

5. 将镜像替换到 K8S  -> test 空间 ->  dubbo-demo-consumer  -> dp.yaml (或直接通过 Dashboard 修改 Deployment 配置)

```
[root@hdss7-200 test]# vim /data/k8s-yaml/test/dubbo-demo-consumer/dp.yaml 
kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: dubbo-demo-consumer
  namespace: test
  labels:
    name: dubbo-demo-consumer
spec:
  replicas: 1
  selector:
    matchLabels:
      name: dubbo-demo-consumer
  template:
    metadata:
      labels:
        app: dubbo-demo-consumer
        name: dubbo-demo-consumer
      annotations:
        prometheus_io_scrape: "true"
        prometheus_io_port: "12346"
        prometheus_io_path: "/"
    spec:
      containers:
      - name: dubbo-demo-consumer
        # 原 Apollo 镜像
        #image: harbor.zq.com/app/dubbo-demo-consumer:apollo_20220423_2223
        # 替换 tomcat 镜像
        image: harbor.zq.com/app/dubbo-demo-web:tomcat_20220428_2200
        ports:
        - containerPort: 8080
          protocol: TCP
        - containerPort: 20880
          protocol: TCP
        env:
        - name: JAR_BALL
          value: dubbo-client.jar
        - name: C_OPTS
          value: -Denv=fat -Dapollo.meta=http://apollo-testconfig.zq.com
        imagePullPolicy: IfNotPresent
      imagePullSecrets:
      - name: harbor
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext:
        runAsUser: 0
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  revisionHistoryLimit: 7
  progressDeadlineSeconds: 600
```

> 说明：
>
> - 因 Dubbo Tomcat 消费者镜像依赖 Apollo 配置中心，故需要 Test 空间 Apollo 服务。

7. 重新应用配置，并检查结果

   `任意 K8S 控制节点应用 DP 配置`

   ```
   [root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.zq.com/test/dubbo-demo-consumer/dp.yaml
   ```

   浏览器访问：<http://dubbo-testdemo.zq.com/hello?name=noah>

   ![img](/images/20220427-k8s15-elk-06.png)


> 参考链接：<https://www.cnblogs.com/noah-luo/p/13501895.html#3-部署elasticsearch>