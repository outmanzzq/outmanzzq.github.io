---
layout: post
title: K8S(11)配置中心实战-单环境交付 Apollo 三组件
categories: k8s,docker
description: Apollo（阿波罗）是一款可靠的分布式配置管理中心，诞生于携程框架研发部，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。
keywords: k8s,docker,devops
---

> Apollo（阿波罗）是一款可靠的分布式配置管理中心，诞生于携程框架研发部，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。

服务端基于Spring Boot 和 Spring Cloud 开发，打包后可以直接运行，不需要额外安装 Tomcat 等应用容器。

Java 客户端不依赖任何框架，能够运行于所有 Java 运行时环境，同时对 Spring/Spring Boot 环境也有较好的支持。

- Github：<https://github.com/apolloconfig/apollo>
- 官方文档：<https://www.apolloconfig.com/#/zh/README>


## 1 Apollo 简介

#### Apollo 基础架构

![img](/images/20220422-k8s11-apollo-01.png)

### 1.1 Apollo 最简架构图：

![img](/images/20220422-k8s11-apollo-02.png)

### 1.2 Apollo 组件部署关系

1. **configservice**  `自带eureka注册中心、配置写入configDB数据库、优先部署、为client提供服务`

2. **adminservice**   `向eureka注册服务、与configservice共用数据库、为portal提供服务`

3. **configservice**  `和adminservice组成一套环境、多个环境就得部署多套config和admin`

4. **portal**         `是web端、各环境共用、只需部署一套、有自己单独的数据库`

## 2 为 Appllo 准备数据库

Apollo 需要使用数据库，如果是 Mysql，需要版本 > 5.6

本次环境 Mysql 部署在 `10.4.7.11` 上，使用 Mysql5.7，为测试简单起见，各环境数据库使用同一个，不做隔离

### 2.1 下载安装 Mysql

#### 2.1.1 Yum 安装 Mysql

```sh
rpm -Uvh https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm
yum -y install yum-utils
yum-config-manager --disable mysql80-community
yum-config-manager --enable mysql57-community

rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
yum install mysql-server -y
```

#### 2.1.2 创建简单配置文件

```sh
cat >/etc/my.cnf <<'EOF'
[mysqld]
character_set_server = utf8mb4
collation_server = utf8mb4_general_ci
init_connect = "SET NAMES 'utf8mb4'"
[mysql]
default-character-set = utf8mb4
EOF
```

#### 2.1.2 启动 Mysql 并初始设置

```sh
systemctl start  mysqld
systemctl enable mysqld
mysql -u root -p`grep password /var/log/messages|awk '{print $NF}'`
# 修改密码
> set global validate_password_policy=0;
> set global validate_password_length=1;
> set password=password('123456');
> flush privileges;

# 检查字符集：需要四个都是 utf8mb4
> \s
```

## 3 初始化 Appllo 数据库

- [configdb 初始化脚本](https://github.com/ctripcorp/apollo/blob/1.5.1/scripts/db/migration/configdb/V1.0.0__initialization.sql)
- [portal 初始化脚本](https://github.com/ctripcorp/apollo/blob/master/scripts/db/migration/portaldb/V1.0.0__initialization.sql)

### 3.1 Configdb 数据库

#### 3.1.1下载脚本并执行：

```sh
wget -O apolloconfig.sql https://raw.githubusercontent.com/ctripcorp/apollo/1.5.1/scripts/db/migration/configdb/V1.0.0__initialization.sql 

# 导入 sql 文件
mysql -uroot -p123456 < apolloconfig.sql
# 检查是否导入成功
mysql -uroot -p123456 -e "show databases;"|grep ApolloConfigDB
```

#### 3.1.2 授权并修改初始数据：

```sh
mysql -uroot -p123456
> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigDB.* to 'apollo'@'10.4.7.%'  identified by "123456";

# 修改数据
> use ApolloConfigDB
> update ServerConfig set Value='http://apollo-config.zq.com/eureka' where Id=1;
```

#### 3.1.3 添加 Config 域名解析：

```sh
vi /var/named/zq.com.zone
mysql				A    10.4.7.11
apollo-config		A    10.4.7.10
apollo-admin		A    10.4.7.10
apollo-portal		A    10.4.7.10

# 重启并验证
systemctl restart named
dig -t A apollo-config.zq.com @10.4.7.11 +short
```

### 3.2 Portal 数据库

由于 Portal 使用的是另一个 portaldb，我们需要在数据库中新建 portdb，并初始化

#### 3.2.1 下载并执行

```sh
wget -O apollo-portal.sql https://raw.githubusercontent.com/ctripcorp/apollo/1.5.1/scripts/db/migration/portaldb/V1.0.0__initialization.sql

# 导入sql文件
mysql -uroot -p123456 < apollo-portal.sql
# 检查是否导入成功
mysql -uroot -p123456 -e "show databases;"|grep ApolloPortalDB
```

#### 3.2.2 授权用户并更新初始数据

都使用 `apollo` 用户来管理数据库是为了方便,如果有相关的安全考虑可以给 Config 和 Portal 分别使用不同的数据库账号

```sql
mysql -uroot -p123456
> grant INSERT,DELETE,UPDATE,SELECT on ApolloPortalDB.* to "apollo"@"10.4.7.%" identified by "123456";

# 更新部门名
> update ApolloPortalDB.ServerConfig set Value='[{"orgId":"zq01","orgName":"研发部"},{"orgId":"zq02","orgName":"运维部"}]' where Id=2;
```

## 4 部署 Configservice

### 4.1 制作 Docker 镜像

操作在 `7.200` 上完成

#### 4.1.1 下载程序包

```sh
wget https://github.com/ctripcorp/apollo/releases/download/v1.5.1/apollo-configservice-1.5.1-github.zip
mkdir /data/dockerfile/apollo-configservice
unzip -o apollo-configservice-1.5.1-github.zip -d /data/dockerfile/apollo-configservice/
```

#### 4.1.2 修改连接数据库配置：

```sh
cd /data/dockerfile/apollo-configservice/config
# 修改数据库连接地址
sed -i 's#fill-in-the-correct-server#mysql.zq.com#g' application-github.properties
# 修改数据库连接用户和密码
sed -i 's#FillInCorrectUser#apollo#g'     application-github.properties
sed -i 's#FillInCorrectPassword#123456#g' application-github.properties

# 查看结果
config]# egrep -v "^#|$^" application-github.properties
spring.datasource.url = jdbc:mysql://mysql.zq.com:3306/ApolloConfigDB?characterEncoding=utf8
spring.datasource.username = apollo
spring.datasource.password = 123456
```

#### 4.1.3 创建启动脚本：

程序中自带的 `start.sh` 启动脚本时不适用与 K8S 运行,因此需要专门下载他们提供的K8S内使用的脚本

```sh
# 1.从官网下载启动脚本
cd /data/dockerfile/apollo-configservice/scripts/
wget https://raw.githubusercontent.com/ctripcorp/apollo/1.5.1/scripts/apollo-on-kubernetes/apollo-config-server/scripts/startup-kubernetes.sh

# 2. 添加一行使用主机名的变量
sed -i '5i APOLLO_CONFIG_SERVICE_NAME=$(hostname -i)' startup-kubernetes.sh

# 3.根据需要修改下jvm限制
```

#### 4.1.4 编写 Dockerfile

[Dockerfile 官方地址](https://github.com/ctripcorp/apollo/blob/1.5.1/scripts/apollo-on-kubernetes/apollo-config-server/Dockerfile)

```sh
cd ..
cat >Dockerfile <<'EOF'
FROM harbor.zq.com/base/jre8:8u112
ENV VERSION 1.5.1

RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &&\
    echo "Asia/Shanghai" > /etc/timezone

ADD apollo-configservice-${VERSION}.jar /apollo-configservice/apollo-configservice.jar
ADD config/  /apollo-configservice/config
ADD scripts/ /apollo-configservice/scripts

CMD ["bash","/apollo-configservice/scripts/startup-kubernetes.sh"]
EOF
```

#### 4.1.5 构建 Docker 镜像

```sh
docker build . -t harbor.zq.com/infra/apollo-configservice:v1.5.1
docker push       harbor.zq.com/infra/apollo-configservice:v1.5.1
```

### 4.2 编写资源配置清单：

```sh
mkdir /data/k8s-yaml/apollo-configservice
cd /data/k8s-yaml/apollo-configservice
```

#### 4.2.1 创建 Config 的 Configmap 资源清单

给 Configservice 创建 cm 资源的清单的目的是方便修改

> 其实里面的内容就是前面修改的`application-github.properties`文件
>
> 如果确定不会修改,可以不创建此 cm ,直接写死配置到 Docker 镜像中

```sh
cat >cm.yaml <<'EOF'
apiVersion: v1
kind: ConfigMap
metadata:
  name: apollo-configservice-cm
  namespace: infra
data:
  application-github.properties: |
    # DataSource
    spring.datasource.url = jdbc:mysql://mysql.zq.com:3306/ApolloConfigDB?characterEncoding=utf8
    spring.datasource.username = apollo
    spring.datasource.password = 123456
    eureka.service.url = http://apollo-config.zq.com/eureka
  app.properties: |
    appId=100003171
EOF
```

> 在同一个 Configmap 资源中,可以添加多个配置文件,上述配置就有两个,分别是:
> - `application-github.properties`
> - `app.properties`

#### 4.2.2 创建 Deployment 资源清单

```sh
cat >dp.yaml <<'EOF'
kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: apollo-configservice
  namespace: infra
  labels: 
    name: apollo-configservice
spec:
  replicas: 1
  selector:
    matchLabels: 
      name: apollo-configservice
  template:
    metadata:
      labels: 
        app: apollo-configservice 
        name: apollo-configservice
    spec:
      volumes:
      - name: configmap-volume
        configMap:
          name: apollo-configservice-cm
      containers:
      - name: apollo-configservice
        image: harbor.zq.com/infra/apollo-configservice:v1.5.1
        ports:
        - containerPort: 8080
          protocol: TCP
        volumeMounts:
        - name: configmap-volume
          mountPath: /apollo-configservice/config
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        imagePullPolicy: IfNotPresent
      imagePullSecrets:
      - name: harbor
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext: 
        runAsUser: 0
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate: 
      maxUnavailable: 1
      maxSurge: 1
  revisionHistoryLimit: 7
  progressDeadlineSeconds: 600
EOF
```

#### 4.2.3 创建 Service 资源清单

```sh
cat >svc.yaml <<'EOF'
kind: Service
apiVersion: v1
metadata: 
  name: apollo-configservice
  namespace: infra
spec:
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  selector: 
    app: apollo-configservice
EOF
```

#### 4.2.4 创建 Ingress 资源清单

```sh
cat >ingress.yaml <<'EOF'
kind: Ingress
apiVersion: extensions/v1beta1
metadata: 
  name: apollo-configservice
  namespace: infra
spec:
  rules:
  - host: apollo-config.zq.com
    http:
      paths:
      - path: /
        backend: 
          serviceName: apollo-configservice
          servicePort: 8080
EOF
```

> Service 中不一定必须暴露 8080 ,分配的 Clusterip 中所有的端口都可以
>
> 但 Ingress 中的 servicePort 一定要与 Service 中暴露的端口匹配

### 4.3 应用资源配置清单：

#### 4.3.1 任意 Node 执行

```sh
kubectl create -f http://k8s-yaml.zq.com/apollo-configservice/cm.yaml
kubectl create -f http://k8s-yaml.zq.com/apollo-configservice/dp.yaml
kubectl create -f http://k8s-yaml.zq.com/apollo-configservice/svc.yaml
kubectl create -f http://k8s-yaml.zq.com/apollo-configservice/ingress.yaml
```

#### 4.3.2 检查启动情况：

```sh
kubectl -n infra get pod|grep apollo-config

# 检查命令
kubectl -n infra logs apollo-configservice-64fc749978-9nz5h --tail=4
```

![img](/images/20220422-k8s11-apollo-03.png)

![img](https://img2018.cnblogs.com/blog/1034759/201912/1034759-20191211164912766-1237255810.png)

![img](/images/20220422-k8s11-apollo-04.png)

需要等到eureka启动以后才可以，接下来使用浏览器访问`apollo-config.zq.com`

![img](/images/20220422-k8s11-apollo-05.png)


## 附：常见问题：

### 1. Configservice Pod 启动失败，提示：运行shell脚本时报错"[[ : not found"

原因：构建镜像 Dockerfile 文件中 CMD 脚本解析 sh 无法解析 /apollo-configservice/scripts/startup-kubernetes.sh 相关语法

```YAML
CMD ["sh","/apollo-configservice/scripts/startup-kubernetes.sh"]
```

解决：将 sh 更换为 bash

```YAML
CMD ["bash","/apollo-configservice/scripts/startup-kubernetes.sh"]
```

参考链接：<https://www.cnblogs.com/han-1034683568/p/7211392.html>



> 原文链接：<https://www.cnblogs.com/noah-luo/p/13501802.html>