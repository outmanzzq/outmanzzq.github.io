---
layout: post
title: K8S(09) 交付实战-通过流水线构建 Dubbo 服务
categories: k8s,docker
description: Apache Dubbo 是一款高性能、轻量级的开源服务框架,提供了六大核心能力：面向接口代理的高性能RPC调用，智能容错和负载均衡，服务自动注册和发现，高度可扩展能力，运行期流量调度，可视化的服务治理与运维。
keywords: k8s,docker,devops
---

> Apache Dubbo 是一款高性能、轻量级的开源服务框架,提供了六大核心能力：面向接口代理的高性能 RPC 调用，智能容错和负载均衡，服务自动注册和发现，高度可扩展能力，运行期流量调度，可视化的服务治理与运维。

- Dobbo 官网：<https://dubbo.apache.org/>
- Dobbo 文档：<https://dubbo.apache.org/zh/docs/>

## 1 Jenkins 流水线准备工作

### 1.1 参数构建要点

**Jenkins 流水线配置的 Java 项目的十个常用参数:**

| 参数名     | 作用                  | 举例或说明                    |
| ---------- | --------------------- | ----------------------------- |
| app_name   | 项目名                | dubbo_demo_service            |
| image_name | Docker 镜像名          | app/dubbo-demo-service        |
| git_repo   | 项目的 Git 地址         | https://x.com/x/x.git         |
| git_ver    | 项目的 Git 分支或版本号 | master                        |
| add_tag    | 镜像标签,常用时间戳   | 191203_1830                   |
| mvn_dir    | 执行 Maven 编译的目录     | ./                            |
| target_dir | 编译产生包的目录      | ./target                      |
| mvn_cmd    | 编译 Maven 项目的命令   | mvc clean package -Dmaven.    |
| base_image | 项目的 Docker 底包      | 不同的项目底包不一样,下拉选择 |
| maven      | Maven 软件版本         | 不同的项目可能 Maven 环境不一样 |

> 除了base_image和maven是choice parameter，其他都是string parameter

### 1.2 创建流水线

#### 1.2.1 创建流水线

创建名为 `dubbo-demo` 的流水线( pipeline ),并设置 `Discard old builds` 为如下

| Discard old builds选项  | 值   |
| ----------------------- | ---- |
| Days to keep builds     | 3    |
| Max # of builds to keep | 30   |

#### 1.2.2 添加 10 个构建参数

`This project is parameterized`点击 `Add Parameter`,分别添加如下 10 个参数

```sh
#第 1 个参数
参数类型 : String Parameter
Name : app_name
Description : 项目名 eg:dubbo-demo-service

#第 2 个参数
参数类型 : String Parameter
Name : image_name
Description : docker镜像名 eg: app/dubbo-demo-service

#第 3 个参数
参数类型 : String Parameter
Name : git_repo
Description : 仓库地址 eg: https://gitee.com/xxx/xxx.git

#第 4 个参数
参数类型 : String Parameter
Name : git_ver
Description : 项目的 Git 分支或版本号

#第 5 个参数
参数类型 : String Parameter
Name : add_tag
Description : 
给docker镜像添加标签组合的一部分,如
$git_ver_$add_tag=master_191203_1830

#第 6 个参数
参数类型 : String Parameter
Name : mvn_dir
Default Value : ./
Description : 执行 Maven 编译的目录,默认是项目根目录, eg: ./

#第 7 个参数
参数类型 : String Parameter
Name : target_dir
Default Value : ./target
Description : 编译产生的 war/jar 包目录 eg: ./dubbo-server/target

#第 8 个参数
参数类型 : String Parameter
Name : mvn_cmd
Default Value : mvn clean package -Dmaven.test.skip=true
Description : 编译命令,常加上 -e -q 参数只输出错误

#第 9 个参数
参数类型 : Choice Parameter
Name : base_image
Choices :
base/jre7:7u80
base/jre8:8u112
Description : 项目的 Docker 底包

#第 10 个参数
参数类型 : Choice Parameter
Name : maven
Choices :
3.6.1
3.2.5
2.2.1
Description : 执行编译使用 Maven 软件版本
```

#### 1.2.3 添加完成效果如下:

![mark](/images/20220420-k8s09-dubbo-01.png)

#### 1.2.4 添加 Pipiline 代码

流水线构建所用的 Pipiline 代码语法比较有专门的生成工具

以下语句的作用大致是分为四步: 拉代码 -> 构建包 -> 移动包-> 打 Docker 镜像并推送

```sh
pipeline {
  agent any 
    stages {
      stage('pull') { //get project code from repo 
        steps {
          sh "git clone ${params.git_repo} ${params.app_name}/${env.BUILD_NUMBER} && cd ${params.app_name}/${env.BUILD_NUMBER} && git checkout ${params.git_ver}"
        }
      }
      stage('build') { //exec mvn cmd
        steps {
          sh "cd ${params.app_name}/${env.BUILD_NUMBER}  && /var/jenkins_home/maven-${params.maven}/bin/${params.mvn_cmd}"
        }
      }
      stage('package') { //move jar file into project_dir
        steps {
          sh "cd ${params.app_name}/${env.BUILD_NUMBER} && cd ${params.target_dir} && mkdir project_dir && mv *.jar ./project_dir"
        }
      }
      stage('image') { //build image and push to registry
        steps {
          writeFile file: "${params.app_name}/${env.BUILD_NUMBER}/Dockerfile", text: """FROM harbor.zq.com/${params.base_image}
ADD ${params.target_dir}/project_dir /opt/project_dir"""
          sh "cd  ${params.app_name}/${env.BUILD_NUMBER} && docker build -t harbor.zq.com/${params.image_name}:${params.git_ver}_${params.add_tag} . && docker push harbor.zq.com/${params.image_name}:${params.git_ver}_${params.add_tag}"
        }
      }
    }
}
```

![img](/images/20220420-k8s09-dubbo-02.png)

### 1.3 用流水线完成 dubbo-service 的构建

记得先在 Harbor 中创建私有仓库 `app`

#### 1.3.1 选择参数化构建

进入 `dubbo-demo` 后,选择的参数化构建 `build with parameters` ,填写 10 个构建的参数

| 参数名     | 参数值                                             |
| ---------- | -------------------------------------------------- |
| app_name   | dubbo-demo-service                                 |
| image_name | app/dubbo-demo-service                             |
| git_repo   | https://gitee.com/outmanzzq/dubbo-demo-service.git |
| git_ver    | master                                             |
| add_tag    | 200509_0800                                        |
| mvn_dir    | ./                                                 |
| target_dir | ./dubbo-server/target                              |
| mvn_cmd    | mvn clean package -Dmaven.test.skip=true           |
| base_image | base/jre8:8u112                                    |
| maven      | 3.6.1                                              |

#### 1.3.2 填写完成效果如下

![mark](/images/20220420-k8s09-dubbo-03.png)

#### 1.3.3 执行构建并检查

填写完以后执行 **bulid**
第一次构建需要下载很多依赖包，时间很长，抽根烟，喝杯茶
经过漫长的等待后，已经构建完成了

**点击`打开 Blue Ocean`查看构建历史及过程：**

![img](/images/20220420-k8s09-dubbo-04.png)

**检查 Harbor 是否已经有这版镜像：**

![mark](/images/20220420-k8s09-dubbo-05.png)

## 2 交付 dubbo-service 到 K8S

### 2.1 准备资源清单

创建清单操作都在 `7.200` 上操作

```sh
mkdir /data/k8s-yaml/dubbo-server/
cd /data/k8s-yaml/dubbo-server
```

#### 2.1.1 创建 Deploy 清单

```sh
cat >dp.yaml <<EOF
kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: dubbo-demo-service
  namespace: app
  labels: 
    name: dubbo-demo-service
spec:
  replicas: 1
  selector:
    matchLabels: 
      name: dubbo-demo-service
  template:
    metadata:
      labels: 
        app: dubbo-demo-service
        name: dubbo-demo-service
    spec:
      containers:
      - name: dubbo-demo-service
        image: harbor.zq.com/app/dubbo-demo-service:master_200509_0800
        ports:
        - containerPort: 20880
          protocol: TCP
        env:
        - name: JAR_BALL
          value: dubbo-server.jar
        imagePullPolicy: IfNotPresent
      imagePullSecrets:
      - name: harbor
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext: 
        runAsUser: 0
      schedulerName: default-scheduler
  strategy:
    type: RollingUpdate
    rollingUpdate: 
      maxUnavailable: 1
      maxSurge: 1
  revisionHistoryLimit: 7
  progressDeadlineSeconds: 600
EOF
```

> 需要根据自己构建镜像的 tag 来修改 image (重要)
> Dubbo 的 Server 服务,只向 Zookeeper 注册并通过 Zookeeper 与 Dobbo 的 Web 交互,不需要对外提供服务
> 因此不需要 Service 资源和 Ingress 资源

### 2.2 创建 K8S 资源

创建 K8S 资源的操作,在任意 Node 节点上操作即可

#### 2.2.1 创建 app 名称空间

业务资源和运维资源等应该通过名称空间来隔离,因此创建专有名称空间 app

```sh
kubectl create namespace app
```

#### 2.2.2 创建 Secret 资源

我们的业务镜像是 Harbor 中的私有项目，所以需要创建 `docker-registry` 的 Secret 资源：

```sh
kubectl -n app \
    create secret docker-registry harbor \
    --docker-server=harbor.zq.com \
    --docker-username=admin \
    --docker-password=Harbor12345
```

#### 2.2.3 应用资源清单

```sh
kubectl apply -f http://k8s-yaml.zq.com/dubbo-server/dp.yaml
```

**3分钟后检查启动情况**

```sh
# 检查 Pod 是否创建：
~]# kubectl -n app get pod
NAME                                  READY   STATUS    RESTARTS   AGE
dubbo-demo-service-79574b6879-cxkls   1/1     Running   0          24s

# 检查是否启动成功：
~]# kubectl -n app logs dubbo-demo-service-79574b6879-cxkls --tail=2
Dubbo server started
Dubbo 服务端已经启动
```

**到 zk 服务器检查是否有服务注册**

```sh
sh /opt/zookeeper/bin/zkCli.sh
[zk: localhost:2181(CONNECTED) 0] ls /
[dubbo, zookeeper]
[zk: localhost:2181(CONNECTED) 1] ls /dubbo
[com.od.dubbotest.api.HelloService]
```

